common_cleanup: &common_cleanup
  - module_name: GoldenLumi
  - module_name: VetoMap
    input_col: Jet
  - module_name: VetoMapFilter
    input_col: Jet
    output_col: Jet
  - module_name: NoiseFilter
  
  - module_name: NObjFilter
    input_col: GoodFatJet
    selection_name: least_one_fatjet
    min_count: 1


common_presel_objects: &common_presel_objects
  - module_name: JetFilter
    input_col: FatJet
    output_col: GoodFatJet
    min_pt: 200
    max_abs_eta: 2.4

common_corrections: &common_corrections
  - module_name: JetScaleCorrections
    input_col: Jet
    output_col: Jet
  - module_name: JetResolutionCorrections
    input_col: Jet
    genjet_col: GenJet
    output_col: Jet

common_pre_sel_weights: &common_pre_sel_weights
  # - module_name: BJetShapeSF
  #   input_col: GoodJet
  - module_name: PileupSF
  # - module_name: L1PrefiringSF
  - module_name: PosNegGenWeight
  - module_name: PileupJetIdSF
    input_col: GoodJet
    working_point: M

common_categories: &common_categories
  - module_name: SimpleCategory
    input_col: HT
    cat_name: HT_Cat
    start: 0
    stop: 3000
    bins: 60

  # - module_name: SimpleCategory
  #   input_col: NJet
  #   cat_name: NJet_Category
  #   start: 4
  #   stop: 7
  #   bins: 3



common_objects: &common_objects
  - module_name: ElectronMaker
    input_col: Electron
    output_col: GoodElectron
    working_point: "loose"
    min_pt: 10
    max_abs_eta: 2.4
    max_mini_iso: 0.1

  - module_name: MuonMaker
    input_col: Muon
    output_col: GoodMuon
    id_working_point: "looseId"
    min_pt: 30
    max_abs_eta: 2.4
    max_mini_iso: 0.1



  - module_name: JetFilter
    input_col: Jet
    output_col: GoodJet
    include_pu_id: True
    include_jet_id: True
    min_pt: 30
    max_abs_eta: 2.4

  - module_name: BQuarkMaker
    input_col: GoodJet
    output_col: MedB
    working_point: M

  - module_name: BQuarkMaker
    input_col: GoodJet
    output_col: LooseB
    working_point: L

  - module_name: BQuarkMaker
    input_col: GoodJet
    output_col: TightB
    working_point: T

  - module_name: HT
    input_col: GoodJet

  - module_name: Count
    input_col: GoodJet
    output_col: NJet 

common_selection: &common_selection
  - module_name: NObjFilter
    input_col: GoodElectron
    selection_name: zero_electron
    min_count: 0
    max_count: 0

  - module_name: NObjFilter
    input_col: GoodMuon
    selection_name: zero_muon
    min_count: 0
    max_count: 0

  - module_name: NObjFilter
    input_col: GoodJet
    selection_name: njets
    min_count: 4
    max_count: 6

  - module_name: VecPt
    input_col: GoodJet
    selection_name: jetpt
    min_pt: 300




common_histograms: &common_histograms
  - module_name: NNMassReco
    input_col: GoodJet
    m3_output: mChi_uncomp
    m4_output: mStop_uncomp
    model_path: "nn_models/nominalBinaryUncompressed0p67_24-09-18-19-53/jetMatcherNNTraced.pt"
    scaler_path: "nn_models/nominalBinaryUncompressed0p67_24-09-18-19-53/scaler.pkl"
  
  - module_name: NNMassReco
    input_col: GoodJet
    m3_output: mChi_comp
    m4_output: mStop_comp
    model_path: "nn_models/nominalBinaryCompressed0p67_24-09-18-20-06/jetMatcherNNTraced.pt"
    scaler_path: "nn_models/nominalBinaryCompressed0p67_24-09-18-20-06/scaler.pkl"
  
  
  - module_name: NNMassPlots
    m3_input: mChi_comp
    m4_input: mStop_comp
    prefix: comp
  
  - module_name: NNMassPlots
    m3_input: mChi_uncomp
    m4_input: mStop_uncomp
    prefix: uncomp

  - module_name: HT
    input_col: GoodJet

  - module_name: JetComboHistograms
    input_col: GoodJet
    prefix: "composite"
    jet_combos:
      - [0,1,2,3]
      - [0,1,2]
      - [1,2,3]

  - module_name: TopVecHistograms
    prefix: "jet"
    input_col: GoodJet
    max_idx: 4

  - module_name: TopVecHistograms
    prefix: "fatjet"
    input_col: GoodFatJet
    max_idx: 1

  - module_name: SimpleHistogram
    hist_name: HT
    input_cols: [HT]
    axes:
      - name: HT
        start: 0
        stop: 3000
        bins: 60
        unit: GeV

analyzer:
  default_run_builder:
    strategy_name: WeightsOnly

  Control:
    - module_name: SimpleHLT
      triggers: [HT,AK8SingleJetPtNoTrim]
    - *common_presel_objects
    - *common_cleanup
    - module_name: SelectOnColumns
      sel_name: pre_selection
    #- *common_corrections
    - *common_objects
    - *common_pre_sel_weights
    - module_name: NObjFilter
      input_col: LooseB
      selection_name: 0bjet
      max_count: 0
    - *common_selection
    - module_name: SelectOnColumns
      sel_name: selection
    - *common_categories
    - *common_histograms

  ControlBNN:
    - module_name: SimpleHLT
      triggers: [HT,AK8SingleJetPtNoTrim]
      should_run:
        sample_type: Data
    - *common_presel_objects
    - *common_cleanup
    - module_name: SelectOnColumns
      sel_name: pre_selection
    #- *common_corrections
    - *common_objects
    - *common_pre_sel_weights
    - module_name: TriggerBNNCorrection
      base_path: trained_bnns/l1_aware/
      correction_pattern: "bnn_correction_{era}.json.gz"
      input_col: GoodJet
    - module_name: NObjFilter
      input_col: LooseB
      selection_name: 0bjet
      max_count: 0
    - *common_selection
    - module_name: SelectOnColumns
      sel_name: selection
    - *common_categories
    - *common_histograms


        

#location_priorities: [".*FNAL.*", ".*US.*", ".*(DE|IT|CH|FR).*", ".*(T0|T1|T2).*","eos"]
location_priorities: [".*(T0|T1|T2).*","eos"]

event_collections:
  # Data samples
  - dataset: 'data_JetHT_*'
    pipelines: [Control]
  
  # Background MC Samples
  - dataset: 'qcd*'
    pipelines: [Control, ControlBNN]
  - dataset: 'diboson*'
    pipelines: [Control, ControlBNN]
  - dataset: 'tt_to_hadronic*'
    pipelines: [Control, ControlBNN]
  - dataset: 'zjets_to_qq*'
    pipelines: [Control , ControlBNN]
  - dataset: 'wjets_to_qq*'
    pipelines: [Control, ControlBNN]
  - dataset: 'single_top*hadronic*'
    pipelines: [Control, ControlBNN]


Postprocessing:
  processors:

    - name: RatioPlot
      inputs:
        - "*/*/*/composite_13_m"
        - "*/*/*/composite_14_m"
        - "*/*/*/composite_24_m"
        - "*/*/*/HT"
      scale: log
      normalize: True
      structure:
        select: {dataset_name: "!Signal*", pipeline: Control}
        group: {era.name: "*"}
        subgroups:
          denominator:
            select: {sample_type: MC}
          numerator:
            select: {sample_type: Data}
        transforms:
          - name: SliceAxes
            slices: {HT_Cat: [1200, null]}
          - name: MergeAxes
            merge_axis_names: [HT_Cat]

          - name: SplitAxes
            split_axis_names: {"variation": "central"}
      output_name: "{prefix}/control/{era.name}/ratio_{era.name}_{name}.png"
    - name: RatioPlot
      inputs:
        - "*/*/*/composite_13_m"
        - "*/*/*/composite_14_m"
        - "*/*/*/composite_24_m"
        - "*/*/*/HT"
      scale: log
      normalize: True
      structure:
        select: {dataset_name: "!Signal*", pipeline: Control}
        group: {era.name: "*"}
        subgroups:
          denominator:
            select: {sample_type: MC}
          numerator:
            select: {sample_type: Data}
        transforms:
          - name: MergeAxes
            merge_axis_names: [HT_Cat]

          - name: SplitAxes
            split_axis_names: {"variation": "central"}
      output_name: "{prefix}/control/{era.name}/ratio_no_cut_{era.name}_{name}.png"

  

  default_plot_config:
    cms_text: "Preliminary"
    image_type: ".png"
    cms_text_color: Black
    legend_num_cols: 2


  default_style_set:
    styles:
      - pattern:
          dataset_name: 'data*'
        style:
          plottype: errorbar
          color: black
          linestyle: null
          marker: 'o'
      - pattern:
          sample_type: 'MC'
        style:
          plottype: fill
      
